/*
Test Cases:
 
 What is the file you would like to open up? tst.txt
 File Not found, Quiting program.
 
 What is the file you would like to open up? Test1.txt
 Ignoring bad input in input file:
 Ignoring bad input in input file:
 Ignoring unknown types of properties appearing in the input file: Commerical 23343.2 Wrong Way
 Ignoring unknown types of properties appearing in the input file: party
 
 All valid Properties
 
 Property id: 0 Address:  572 Randon Road Rental Estimated value: 533000 Days Since Last Payment: 100 NOT occupied
 Property id: 1 Address:  350 Red Towers NOT Rental Estimated value: 5e+13 Days Since Last Payment: 123 Discounted Discount 0.3
 Property id: 2 Address:  142 Cs Blvd NOT Rental Estimated value: 2.5e+10 Days Since Last Payment: 234 occuppied
 Property id: 3 Address:  142 Ca Blvd NOT Rental Estimated value: 250000 Days Since Last Payment: 345 occuppied
 Property id: 4 Address:  234 FarmFarm lane NOT Rental Estimated value: 3.9e+06 Days Since Last Payment: 49 Discounted  Discount 0.4 NOTE: Farm property
 Property id: 5 Address:  350 Blue Towers NOT Rental Estimated value: 1.23457e+06 Days Since Last Payment: 56 Discounted Discount 0.2
 Property id: 6 Address:  572 Random Road Rental Estimated value: 533000 Days Since Last Payment: 456 NOT occupied
 Property id: 7 Address:  234 Farmland lane Rental Estimated value: 2.3e+06 Days Since Last Payment: 23 Discounted  Discount 0.4 NOTE: Farm property
 
 NOW PRINTING TAX REPORT:
 
 ** Taxes due for the property at:   572 Randon Road
 Property id: 	0
 This property has an estimated value of: 533000
 Last payment: 100 days ago
 Taxes due on this property are: 4797
 Taxes due on this property in : 90 days.
 
 ** Taxes due for the property at:   350 Red Towers
 Property id: 	1
 This property has an estimated value of: 5e+13
 Last payment: 123 days ago
 Taxes due on this property are: 3.5e+11
 Taxes due on this property in : 60 days.
 
 ** Taxes due for the property at:   142 Cs Blvd
 Property id: 	2
 This property has an estimated value of: 2.5e+10
 Last payment: 234 days ago
 Taxes due on this property are: 1.5e+08
 Taxes due on this property in : 60 days.
 
 ** Taxes due for the property at:   142 Ca Blvd
 Property id: 	3
 This property has an estimated value of: 250000
 Last payment: 345 days ago
 Taxes due on this property are: 1500
 Taxes due on this property in : 90 days.
 
 ** Taxes due for the property at:   234 FarmFarm lane
 Property id: 	4
 This property has an estimated value of: 3.9e+06
 Last payment: 49 days ago
 Taxes due on this property are: 23400
 Taxes due on this property in : 100 days.
 
 ** Taxes due for the property at:   350 Blue Towers
 Property id: 	5
 This property has an estimated value of: 1.23457e+06
 Last payment: 56 days ago
 Taxes due on this property are: 9876.54
 Taxes due on this property in : 90 days.
 
 ** Taxes due for the property at:   572 Random Road
 Property id: 	6
 This property has an estimated value of: 533000
 Last payment: 456 days ago
 Taxes due on this property are: 4797
 Taxes due on this property in : 90 days.
 
 ** Taxes due for the property at:   234 Farmland lane
 Property id: 	7
 This property has an estimated value of: 2.3e+06
 Last payment: 23 days ago
 Taxes due on this property are: 16560
 Taxes due on this property in : 100 days.
 
 
 CHOOSE AN OPTION TO SORT TAXES:
 1 to sort taxes by address
 2 to sort taxes by taxes due
 2
 
 NOW PRINTING TAX REPORT:
 
 ** Taxes due for the property at:   142 Ca Blvd
 Property id: 	3
 This property has an estimated value of: 250000
 Last payment: 345 days ago
 Taxes due on this property are: 1500
 Taxes due on this property in : 90 days.
 
 ** Taxes due for the property at:   572 Randon Road
 Property id: 	0
 This property has an estimated value of: 533000
 Last payment: 100 days ago
 Taxes due on this property are: 4797
 Taxes due on this property in : 90 days.
 
 ** Taxes due for the property at:   572 Random Road
 Property id: 	6
 This property has an estimated value of: 533000
 Last payment: 456 days ago
 Taxes due on this property are: 4797
 Taxes due on this property in : 90 days.
 
 ** Taxes due for the property at:   350 Blue Towers
 Property id: 	5
 This property has an estimated value of: 1.23457e+06
 Last payment: 56 days ago
 Taxes due on this property are: 9876.54
 Taxes due on this property in : 90 days.
 
 ** Taxes due for the property at:   234 Farmland lane
 Property id: 	7
 This property has an estimated value of: 2.3e+06
 Last payment: 23 days ago
 Taxes due on this property are: 16560
 Taxes due on this property in : 100 days.
 
 ** Taxes due for the property at:   234 FarmFarm lane
 Property id: 	4
 This property has an estimated value of: 3.9e+06
 Last payment: 49 days ago
 Taxes due on this property are: 23400
 Taxes due on this property in : 100 days.
 
 ** Taxes due for the property at:   142 Cs Blvd
 Property id: 	2
 This property has an estimated value of: 2.5e+10
 Last payment: 234 days ago
 Taxes due on this property are: 1.5e+08
 Taxes due on this property in : 60 days.
 
 ** Taxes due for the property at:   350 Red Towers
 Property id: 	1
 This property has an estimated value of: 5e+13
 Last payment: 123 days ago
 Taxes due on this property are: 3.5e+11
 Taxes due on this property in : 60 days.

 

 
 
 
 What is the file you would like to open up? Test2.txt
 Ignoring bad input in input file:
 Ignoring unknown types of properties appearing in the input file: junk
 Ignoring bad input in input file:
 Ignoring unknown types of properties appearing in the input file: Hotman
 Ignoring bad input in input file:
 Ignoring bad RESIDENTIAL in input file: Residential 0 Banana-boot Road
 Ignoring bad input in input file:
 Ignoring bad input in input file:
 
 All valid Properties
 
 Property id: 0 Address:  977 Tude Block NOT Rental Estimated value: 598776 Days Since Last Payment: 123 Discounted Discount 0.23
 Property id: 1 Address:  234 Closeaway lane Rental Estimated value: 2.3e+13 Days Since Last Payment: 23 Discounted  Discount 0.4 NOTE: Farm property
 Property id: 2 Address:  354 Dragon Tree NOT Rental Estimated value: 5.009e+11 Days Since Last Payment: 234 Not Discounted
 Property id: 3 Address:  101 Block Road NOT Rental Estimated value: 2.22266e+06 Days Since Last Payment: 345 occuppied
 Property id: 4 Address:  129 Locust Lane Rental Estimated value: 5e+06 Days Since Last Payment: 456 NOT occupied
 Property id: 5 Address:  234 Faraway lane Rental Estimated value: 2.3e+06 Days Since Last Payment: 23 Discounted  Discount 0.4 NOTE: Farm property
 Property id: 6 Address:  85 Blue Court NOT Rental Estimated value: 7.33421e+06 Days Since Last Payment: 567 NOT occupied
 Property id: 7 Address:  200 Green Grass Rental Estimated value: 4.38484e+07 Days Since Last Payment: 213 Discounted Discount 0.2
 
 NOW PRINTING TAX REPORT:
 
 ** Taxes due for the property at:   977 Tude Block
 Property id: 	0
 This property has an estimated value of: 598776
 Last payment: 123 days ago
 Taxes due on this property are: 4610.58
 Taxes due on this property in : 90 days.
 
 ** Taxes due for the property at:   234 Closeaway lane
 Property id: 	1
 This property has an estimated value of: 2.3e+13
 Last payment: 23 days ago
 Taxes due on this property are: 1.656e+11
 Taxes due on this property in : 100 days.
 
 ** Taxes due for the property at:   354 Dragon Tree
 Property id: 	2
 This property has an estimated value of: 5.009e+11
 Last payment: 234 days ago
 Taxes due on this property are: 5.009e+09
 Taxes due on this property in : 60 days.
 
 ** Taxes due for the property at:   101 Block Road
 Property id: 	3
 This property has an estimated value of: 2.22266e+06
 Last payment: 345 days ago
 Taxes due on this property are: 13336
 Taxes due on this property in : 90 days.
 
 ** Taxes due for the property at:   129 Locust Lane
 Property id: 	4
 This property has an estimated value of: 5e+06
 Last payment: 456 days ago
 Taxes due on this property are: 45000
 Taxes due on this property in : 90 days.
 
 ** Taxes due for the property at:   234 Faraway lane
 Property id: 	5
 This property has an estimated value of: 2.3e+06
 Last payment: 23 days ago
 Taxes due on this property are: 16560
 Taxes due on this property in : 100 days.
 
 ** Taxes due for the property at:   85 Blue Court
 Property id: 	6
 This property has an estimated value of: 7.33421e+06
 Last payment: 567 days ago
 Taxes due on this property are: 66007.9
 Taxes due on this property in : 90 days.
 
 ** Taxes due for the property at:   200 Green Grass
 Property id: 	7
 This property has an estimated value of: 4.38484e+07
 Last payment: 213 days ago
 Taxes due on this property are: 420945
 Taxes due on this property in : 90 days.
 
 
 CHOOSE AN OPTION TO SORT TAXES:
 1 to sort taxes by address
 2 to sort taxes by taxes due
 2
 
 NOW PRINTING TAX REPORT:
 
 ** Taxes due for the property at:   977 Tude Block
 Property id: 	0
 This property has an estimated value of: 598776
 Last payment: 123 days ago
 Taxes due on this property are: 4610.58
 Taxes due on this property in : 90 days.
 
 ** Taxes due for the property at:   101 Block Road
 Property id: 	3
 This property has an estimated value of: 2.22266e+06
 Last payment: 345 days ago
 Taxes due on this property are: 13336
 Taxes due on this property in : 90 days.
 
 ** Taxes due for the property at:   234 Faraway lane
 Property id: 	5
 This property has an estimated value of: 2.3e+06
 Last payment: 23 days ago
 Taxes due on this property are: 16560
 Taxes due on this property in : 100 days.
 
 ** Taxes due for the property at:   129 Locust Lane
 Property id: 	4
 This property has an estimated value of: 5e+06
 Last payment: 456 days ago
 Taxes due on this property are: 45000
 Taxes due on this property in : 90 days.
 
 ** Taxes due for the property at:   85 Blue Court
 Property id: 	6
 This property has an estimated value of: 7.33421e+06
 Last payment: 567 days ago
 Taxes due on this property are: 66007.9
 Taxes due on this property in : 90 days.
 
 ** Taxes due for the property at:   200 Green Grass
 Property id: 	7
 This property has an estimated value of: 4.38484e+07
 Last payment: 213 days ago
 Taxes due on this property are: 420945
 Taxes due on this property in : 90 days.
 
 ** Taxes due for the property at:   354 Dragon Tree
 Property id: 	2
 This property has an estimated value of: 5.009e+11
 Last payment: 234 days ago
 Taxes due on this property are: 5.009e+09
 Taxes due on this property in : 60 days.
 
 ** Taxes due for the property at:   234 Closeaway lane
 Property id: 	1
 This property has an estimated value of: 2.3e+13
 Last payment: 23 days ago
 Taxes due on this property are: 1.656e+11
 Taxes due on this property in : 100 days.

 
 
 
 
 What is the file you would like to open up? Test3.txt
 Ignoring unknown types of properties appearing in the input file: tricky
 Ignoring bad input in input file:
 Ignoring unknown types of properties appearing in the input file: missing
 Ignoring bad input in input file:
 Ignoring unknown types of properties appearing in the input file: Frammm 0 7700000 12 234 Meeting lane
 
 All valid Properties
 
 Property id: 0 Address:  300 Randon Road NOT Rental Estimated value: 533000 Days Since Last Payment: 425 occuppied
 Property id: 1 Address:  572 Randon Road Rental Estimated value: 5.33e+14 Days Since Last Payment: 45 NOT occupied
 Property id: 2 Address:  300 Blue Bag NOT Rental Estimated value: 1.23457e+06 Days Since Last Payment: 12 Discounted Discount 0.2
 Property id: 3 Address:  350 Blue Bag Rental Estimated value: 8.34733e+06 Days Since Last Payment: 23 Not Discounted
 Property id: 4 Address:  234 Green Blvd Rental Estimated value: 43534 Days Since Last Payment: 34 NOT occupied
 Property id: 5 Address:  234 Party lane Rental Estimated value: 8.8e+06 Days Since Last Payment: 90 Discounted  Discount 0.4 NOTE: Farm property
 Property id: 6 Address:  234 Meeting lane NOT Rental Estimated value: 7.7e+06 Days Since Last Payment: 12 Discounted  Discount 0.4 NOTE: Farm property
 
 NOW PRINTING TAX REPORT:
 
 ** Taxes due for the property at:   300 Randon Road
 Property id: 	0
 This property has an estimated value of: 533000
 Last payment: 425 days ago
 Taxes due on this property are: 3198
 Taxes due on this property in : 90 days.
 
 ** Taxes due for the property at:   572 Randon Road
 Property id: 	1
 This property has an estimated value of: 5.33e+14
 Last payment: 45 days ago
 Taxes due on this property are: 4.797e+12
 Taxes due on this property in : 60 days.
 
 ** Taxes due for the property at:   300 Blue Bag
 Property id: 	2
 This property has an estimated value of: 1.23457e+06
 Last payment: 12 days ago
 Taxes due on this property are: 9876.54
 Taxes due on this property in : 90 days.
 
 ** Taxes due for the property at:   350 Blue Bag
 Property id: 	3
 This property has an estimated value of: 8.34733e+06
 Last payment: 23 days ago
 Taxes due on this property are: 100168
 Taxes due on this property in : 90 days.
 
 ** Taxes due for the property at:   234 Green Blvd
 Property id: 	4
 This property has an estimated value of: 43534
 Last payment: 34 days ago
 Taxes due on this property are: 391.806
 Taxes due on this property in : 90 days.
 
 ** Taxes due for the property at:   234 Party lane
 Property id: 	5
 This property has an estimated value of: 8.8e+06
 Last payment: 90 days ago
 Taxes due on this property are: 63360
 Taxes due on this property in : 100 days.
 
 ** Taxes due for the property at:   234 Meeting lane
 Property id: 	6
 This property has an estimated value of: 7.7e+06
 Last payment: 12 days ago
 Taxes due on this property are: 46200
 Taxes due on this property in : 100 days.
 
 
 CHOOSE AN OPTION TO SORT TAXES:
 1 to sort taxes by address
 2 to sort taxes by taxes due
 1
 
 NOW PRINTING TAX REPORT:
 
 ** Taxes due for the property at:   234 Green Blvd
 Property id: 	4
 This property has an estimated value of: 43534
 Last payment: 34 days ago
 Taxes due on this property are: 391.806
 Taxes due on this property in : 90 days.
 
 ** Taxes due for the property at:   234 Party lane
 Property id: 	5
 This property has an estimated value of: 8.8e+06
 Last payment: 90 days ago
 Taxes due on this property are: 63360
 Taxes due on this property in : 100 days.
 
 ** Taxes due for the property at:   234 Meeting lane
 Property id: 	6
 This property has an estimated value of: 7.7e+06
 Last payment: 12 days ago
 Taxes due on this property are: 46200
 Taxes due on this property in : 100 days.
 
 ** Taxes due for the property at:   300 Blue Bag
 Property id: 	2
 This property has an estimated value of: 1.23457e+06
 Last payment: 12 days ago
 Taxes due on this property are: 9876.54
 Taxes due on this property in : 90 days.
 
 ** Taxes due for the property at:   300 Randon Road
 Property id: 	0
 This property has an estimated value of: 533000
 Last payment: 425 days ago
 Taxes due on this property are: 3198
 Taxes due on this property in : 90 days.
 
 ** Taxes due for the property at:   350 Blue Bag
 Property id: 	3
 This property has an estimated value of: 8.34733e+06
 Last payment: 23 days ago
 Taxes due on this property are: 100168
 Taxes due on this property in : 90 days.
 
 ** Taxes due for the property at:   572 Randon Road
 Property id: 	1
 This property has an estimated value of: 5.33e+14
 Last payment: 45 days ago
 Taxes due on this property are: 4.797e+12
 Taxes due on this property in : 60 days.



*/

#include <iostream>
#include <fstream>
#include <sstream>
#include <vector>
#include "Property.h"
#include "Residential.h"
#include "Commercial.h"
#include "Farm.h"

using namespace std;

bool checkFile(string fileName);//checks to see if the file name exists

void loadFile (vector<Property*> &propertyVector, string fileName);//loads the file and puts it in a vector
//makes sure that lines are valid, discards the invalid lines and moves on
//uses the a vector of pointers in the class

void printProperties (vector<Property*> & propertyVector);//displays all the valid properties.

void printTaxes (vector<Property*> & propertyVector);//displays the tax report, using the class

void sortTaxes (vector<Property*> & propertyVector);//sorts the vector according the address or tax rate.



int main() {
    vector<Property*> propertyVector;
    string fileName;
    
    cout << "What is the file you would like to open up? ";
    cin >> fileName;
    
    if (checkFile(fileName)== false) {//if the file is not found
        cout << "File Not found, Quiting program." << endl;
    }
    else if (checkFile(fileName)== true){//if the file is found
        loadFile(propertyVector, fileName);//load the file
        printProperties (propertyVector);//display the properties
        printTaxes(propertyVector);//print the tax report
        sortTaxes(propertyVector);// prompt user how to sort tax report, sorts report.
        printTaxes (propertyVector);//displays the sorted tax report.
    }
    
    
    return 0;
}



bool checkFile(string fileName)
{
    ifstream Infield(fileName);
    return Infield.good();
}

void loadFile (vector<Property*> &propertyVector, string fileName)
{
    string typeIn;
    bool rentalIn;
    double priceIn = 0;
    int daysIn = 0;
    bool occupiedIn;
    bool taxesIn;
    double rateIn= 0;
    string addressIn;
    const string COMMERSTR = "Commercial";
    const string RESIDSTR = "Residential";
    const string FARMSTR = "Farm";
    const string EMPTY = "";
    ifstream in_file;
    in_file.open(fileName);
    
    
    string currentLine;
    
    while (getline(in_file, currentLine)) {//while there are still more lines in the file
        
        istringstream streamInput(currentLine);//puts the line into a string stream.
        
        streamInput >> typeIn;
        
        if (typeIn == RESIDSTR) {//if the first word is residential
            
            if (streamInput >> rentalIn >> priceIn >> daysIn >> occupiedIn ) {//if each word will go into it's type, then put it in it's type.
                
                getline(streamInput, addressIn);//puts the rest of streamInput into addressIn;
                
                Property * thisPorperty = new Residential( rentalIn,  priceIn, daysIn,  occupiedIn, addressIn);//Property pointer on heap, residential
                propertyVector.push_back(thisPorperty);

                
            }
            else{
                cout << "Ignoring bad RESIDENTIAL in input file: " << currentLine << endl;;
            }
            
        }
        else if (typeIn == COMMERSTR){//if the first word is commercial
            if (streamInput >> rentalIn >> priceIn >> daysIn >> taxesIn >> rateIn) {
                
                getline(streamInput, addressIn);//puts the rest into the address.
                
                Property * thisProperty = new Commercial(  rentalIn,  priceIn, daysIn,  taxesIn,  rateIn,  addressIn);
                propertyVector.push_back(thisProperty);

            }
            else{
                cout << "Ignoring bad COMMERCIAL in input file: " << currentLine << endl;
            }
            
        }
        else if (typeIn == FARMSTR){
            if (streamInput >> rentalIn >> priceIn >> daysIn) {
                
                getline(streamInput, addressIn);
                
                Property * thisProperty = new Farm(rentalIn, priceIn, daysIn, addressIn);
                propertyVector.push_back(thisProperty);
                
            }
            else{
                cout << "Ignoring bad FARM in input file: " << currentLine << endl;
            }
        }
        else if (typeIn == EMPTY){
            cout << "Ignoring bad input in input file:" << typeIn << endl;
        }
        else{cout << "Ignoring unknown types of properties appearing in the input file: "<< currentLine << endl;}//if unknown type of property
        
        if (in_file.fail()) {//until there is no more input.
            break;
        }
        
        typeIn= EMPTY;//reseting the type.
    }
    
    in_file.close();
    
}

void printProperties (vector<Property*> & propertyVector)
{
    cout << endl << "All valid Properties" << endl <<  endl;
    for (long whichProp = 0; whichProp < propertyVector.size(); whichProp++) {
        
        cout << propertyVector[whichProp]->toString();
    }
}


void printTaxes (vector<Property*> & propertyVector)
{
    cout << endl << "NOW PRINTING TAX REPORT:" << endl << endl;
    for (long whichProp = 0; whichProp< propertyVector.size(); whichProp++) {
        cout << "** Taxes due for the property at:  " << propertyVector[whichProp]->getAddress() << endl;
        cout << "Property id: \t" << propertyVector[whichProp]->getId() << endl;
        cout << "This property has an estimated value of: " << propertyVector[whichProp]->getPrice() << endl;
        cout << "Last payment: " << propertyVector[whichProp]->getDays() << " days ago" << endl;
        cout << "Taxes due on this property are: " << propertyVector[whichProp]->toTaxes()<< endl;
        cout << "Taxes due on this property in : " << propertyVector[whichProp]->toDeadline() << " days." <<  endl << endl;
    }
}

void sortTaxes (vector<Property*> & propertyVector)
{
    vector<Property*> sortVector;
    int option;
    double smallest = 0;
    long location = 0;
    const int BYADDRESS = 1;
    const int BYTAXES = 2;
    const long START= 0;
    const long LAST = 1;
    
    string numberStr;
    string addressWord;
    string nextaddressWord;
    int addressNum= 0;
    int nextNum = 0;
    
    
    cout << endl <<"CHOOSE AN OPTION TO SORT TAXES: " << endl;
    cout << "1 to sort taxes by address" << endl;
    cout << "2 to sort taxes by taxes due" << endl;
    cin >> option;
    if (option == BYADDRESS) {
        while (true) {//orders a sorted vector.
            location = START;//location gets reset.
            istringstream addressline (propertyVector [START] ->getAddress());//puts the first addressline into a stringstream
            addressline >> numberStr >> addressWord;
            addressNum = atoi(numberStr.c_str());
            
            for (long whichProp = 1; whichProp < propertyVector.size(); whichProp++) {//goes through each property finds the smallest
                
                istringstream addressline (propertyVector [whichProp] ->getAddress());//puts the first addressline into a stringstream
                addressline >> numberStr >> nextaddressWord ;
                nextNum = atoi(numberStr.c_str());
                
                if (nextNum < addressNum) {
                    addressNum = nextNum;
                    location = whichProp;
                }
                if (nextNum == addressNum && nextaddressWord < addressWord) {
                    addressWord = nextaddressWord;
                    location = whichProp;
                }
                
            }
            sortVector.push_back(propertyVector[location]);//copy the smallest value to a new vector
            propertyVector.erase(propertyVector.begin() + location); // deletes location from that vector.
            
            if (propertyVector.size() == LAST) {//if it's at the last one.(biggest value)
                sortVector.push_back(propertyVector [START]);//sortvector gets the biggest one at the end of the vector
                break;//sorted the last one.
            }
            
            
        }
        
        propertyVector = sortVector;//the original vector gets the sorted vector.
        
        sortVector.clear();//clears the sort vector
        
        
        
    }
    else if (option == BYTAXES){
        while (true) {//keep going until it sorts the last one.
            
            
            location = START;//location gets reset.
            smallest = propertyVector [START]->toTaxes();//start at the first price
            for (long whichProp = 1; whichProp < propertyVector.size(); whichProp++) {//goes through each property starting at the nextone
                if (propertyVector[whichProp]->toTaxes() < smallest) {
                    smallest = propertyVector[whichProp]->toTaxes();
                    location =whichProp;
                }
                
            }
            sortVector.push_back(propertyVector[location]);//copy the smallest value to a new vector
            propertyVector.erase(propertyVector.begin() + location); // deletes location from that vector.
            
            if (propertyVector.size() == LAST) {//if it's at the last one.(biggest value)
                sortVector.push_back(propertyVector [START]);//sortvector gets the biggest one at the end of the vector
                break;//sorted the last one.
            }
            
        }
        
        propertyVector = sortVector;//the original vector gets the sorted vector.
        
        
    }
    
}